# 📱 קבוצות ושיתוף

## 🎯 מה זה עושה?

קבוצות מאפשרות ליוגב **לשתף רשימות עם אנשים אחרים**.

### סוגי קבוצות (7 סוגים):
| סוג | אימוג'י | שימוש |
|-----|---------|-------|
| `family` | 👨‍👩‍👧‍👦 | משפחה - כל בני הבית |
| `building` | 🏢 | ועד בית |
| `kindergarten` | 🎒 | ועד גן |
| `friends` | 👥 | חברים |
| `event` | 🎉 | אירוע חד-פעמי |
| `roommates` | 🏠 | שותפים לדירה |
| `other` | 📋 | אחר |

---

## 📱 איך נראה מסך הקבוצות

```
┌─────────────────────────────────────────────────────────┐
│  👥 הקבוצות שלי                         🔍 חיפוש       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌────────────────────────────────────────────────────┐ │
│  │ 🏠 משפחת כהן                                      │ │
│  │    5 חברים                                        │ │
│  │    אתה מנהל                                       │ │
│  └────────────────────────────────────────────────────┘ │
│                                                         │
│  ┌────────────────────────────────────────────────────┐ │
│  │ 🎂 יום הולדת דני                                  │ │
│  │    8 חברים                                        │ │
│  │    הוזמנת                                         │ │
│  └────────────────────────────────────────────────────┘ │
│                                                         │
├─────────────────────────────────────────────────────────┤
│               [ + צור קבוצה חדשה ]                      │
└─────────────────────────────────────────────────────────┘
```

---

## 🔄 זרימה - יצירת קבוצה חדשה

```
┌─────────────────────────────────────────────────────────┐
│  יוגב לוחץ "+ צור קבוצה חדשה"                           │
└──────────────────────┬──────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────────┐
│  נפתח מסך יצירת קבוצה:                                  │
│  • שם הקבוצה: "מסיבת על האש"                           │
│  • סוג: 🎉 אירוע (event)                               │
│  • תיאור (אופציונלי)                                   │
│  (הצבע והאימוג'י נגזרים אוטומטית מהסוג!)               │
└──────────────────────┬──────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────────┐
│  יוגב מזמין חברים:                                      │
│  • בוחר אנשי קשר מהטלפון                               │
│  • או מכניס אימייל/טלפון ידנית                         │
└──────────────────────┬──────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────────┐
│  יוגב לוחץ "צור קבוצה"                                  │
└──────────────────────┬──────────────────────────────────┘
                       ↓
         ┌─────────────┴─────────────┐
         ↓                           ↓
    [הצלחה]                  מוזמנים שאינם רשומים
         ↓                   מקבלים הזמנה ממתינה
    הקבוצה נוצרת
    יוגב הוא המנהל
```

---

## 📖 דוגמה - יוגב מזמין את שרה לקבוצה

**הסיטואציה:** יוגב רוצה לצרף את שרה (אשתו) לקבוצת המשפחה

**מה יוגב עושה:**
1. פותח את טאב "קבוצות" 👥
2. לוחץ על "משפחת כהן"
3. לוחץ "הזמן חברים"
4. בוחר את שרה מאנשי הקשר
5. לוחץ "שלח הזמנה"

**מה קורה לשרה:**
- אם שרה רשומה → מופיעה לה התראה 📬
- אם שרה לא רשומה → ההזמנה ממתינה

---

## 🔐 תפקידים בקבוצה

| תפקיד | מה יכול לעשות |
|-------|--------------|
| **בעלים** (Owner) | הכל - כולל **מחיקת קבוצה** והעברת בעלות |
| **מנהל** (Admin) | ניהול חברים, עריכה - **לא יכול למחוק קבוצה** |
| **עורך** (Editor) | לערוך רשימות, להוסיף/להסיר מוצרים |
| **צופה** (Viewer) | רק לראות - בלי לערוך |

> **חשוב:** רק הבעלים (Owner) יכול למחוק קבוצה! מנהלים (Admin) יכולים לנהל חברים אבל לא למחוק.

---

## 📬 הזמנות ממתינות

כשמישהו מזמין את יוגב לקבוצה:

```
┌─────────────────────────────────────────────────────────┐
│  📬 הזמנות ממתינות (2)                                  │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌────────────────────────────────────────────────────┐ │
│  │ 🎂 יום הולדת דני                                  │ │
│  │    הוזמנת על ידי: דני לוי                         │ │
│  │                                                    │ │
│  │    [✅ אשר]        [❌ דחה]                       │ │
│  └────────────────────────────────────────────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 📖 דוגמה - יוגב מקבל הזמנה

**הסיטואציה:** דני הזמין את יוגב לקבוצת "על האש"

**מה יוגב רואה:**
1. בדף הבית - 📬 עם מספר (1)
2. לוחץ על ה-📬
3. רואה את ההזמנה מדני

**יוגב לוחץ "אשר":**
- יוגב מתווסף לקבוצה
- יוגב יכול לראות/לערוך את הרשימות של הקבוצה

**יוגב לוחץ "דחה":**
- ההזמנה נמחקת
- יוגב לא מצורף לקבוצה

---

## 💾 איפה המידע נשמר?

### קבצים ותפקידים

| קובץ | מה הוא עושה? |
|------|-------------|
| [groups_list_screen.dart](../../../lib/screens/groups/groups_list_screen.dart) | מסך רשימת הקבוצות |
| [create_group_screen.dart](../../../lib/screens/groups/create_group_screen.dart) | מסך יצירת קבוצה |
| [group_details_screen.dart](../../../lib/screens/groups/group_details_screen.dart) | מסך פרטי קבוצה |
| [pending_group_invites_screen.dart](../../../lib/screens/groups/pending_group_invites_screen.dart) | הזמנות ממתינות |
| [groups_provider.dart](../../../lib/providers/groups_provider.dart) | ניהול הקבוצות |
| [group.dart](../../../lib/models/group.dart) | מבנה קבוצה |

### מבנה נתונים ב-Firebase

**קבוצה:**
```
groups/קבוצה_id:
  id: "קבוצה_id"
  name: "משפחת כהן"
  type: "family"              // family/building/kindergarten/friends/event/roommates/other
  description: "הקבוצה של משפחת כהן"
  image_url: null             // תמונת קבוצה (אופציונלי)
  created_by: "יוגב_id"       // מזהה היוצר (הבעלים)
  created_at: timestamp
  updated_at: timestamp
  members: {                   // מפה (Map) - לא מערך!
    "יוגב_id": {
      role: "owner",           // owner/admin/editor/viewer
      joined_at: timestamp
    },
    "שרה_id": {
      role: "editor",
      joined_at: timestamp
    }
  }
  settings: {                  // הגדרות קבוצה
    allow_member_invite: true
  }
  extra_fields: {}             // שדות נוספים לפי סוג קבוצה
```

> **שים לב:** אין שדות `color` ו-`emoji` - הם נגזרים אוטומטית מסוג הקבוצה (`type`)!

**הזמנה ממתינה:**
```
group_invites/הזמנה_id:
  id: "הזמנה_id"
  group_id: "קבוצה_id"
  group_name: "משפחת כהן"
  invited_by: "יוגב_id"
  invited_by_name: "יוגב כהן"
  invited_email: "sara@gmail.com"
  invited_phone: "0501234567"
  invited_name: "שרה"
  status: "pending"           // pending/accepted/rejected/expired
  created_at: timestamp
  responded_at: null          // מתי הוזמן הגיב
  accepted_by_user_id: null   // מזהה המשתמש שקיבל (אחרי הרשמה)
```

---

## 📶 טיפול במצב ללא אינטרנט

**מה קורה:**
1. אין אינטרנט? → הודעה "אין חיבור לאינטרנט"
2. הקבוצות מוצגות (לקריאה בלבד)
3. לא ניתן ליצור/לערוך/להזמין עד שיש חיבור
4. כשהאינטרנט חוזר → הודעה נעלמת, ניתן לערוך

---

## 🔢 מגבלות

| מגבלה | ערך | סיבה |
|-------|-----|------|
| מקסימום חברים בקבוצה | 100 | מספיק לרוב השימושים, שמירה על ביצועים |
| מקסימום קבוצות למשתמש | 50 | ריאליסטי, מונע ספאם |

---

## 🚪 יציאה מקבוצה

**הזרימה:**
1. חבר לוחץ "עזוב קבוצה"
2. מופיע אישור: "בטוח שברצונך לעזוב?"
3. אם מאשר → יוצא מהקבוצה
4. הודעה נשלחת למנהלים בלבד (לא לכל החברים)

**מה קורה אם הבעלים רוצה לעזוב?**
- הבעלים **חייב** להעביר בעלות לפני יציאה
- לא ניתן לעזוב כבעלים בלי למנות בעלים חדש
- זה מחייב לממש "העברת בעלות"

---

## ✏️ עריכת פרטי קבוצה

**מי יכול לערוך:**
- ✅ בעלים - יכול לערוך הכל
- ✅ מנהל - יכול לערוך שם ותיאור
- ❌ עורך - לא יכול
- ❌ צופה - לא יכול

**מה אפשר לערוך:**
- שם הקבוצה
- תיאור
- תמונה (אם יש)
- הגדרות (מי יכול להזמין וכו')

---

## ⚠️ דברים לבדוק

### עובד:
- ✅ יצירת קבוצה חדשה
- ✅ הזמנת חברים (רשומים ולא רשומים)
- ✅ אישור/דחיית הזמנות
- ✅ הצגת חברי קבוצה
- ✅ תפקידים (owner/admin/editor/viewer)
- ✅ מחיקת קבוצה (רק על ידי Owner)

### צריך להוסיף/לתקן:
- ⚠️ **אין אינטרנט** - הודעה + קריאה בלבד
- ⚠️ **הגבלת 100 חברים** - בדיקה לפני הזמנה
- ⚠️ **הגבלת 50 קבוצות** - בדיקה לפני יצירה
- ⚠️ **יציאה מקבוצה** - אישור + הודעה למנהלים
- ⚠️ **העברת בעלות** - לא ממומש! הקוד חוסם ב-[firebase_group_repository.dart](../../../lib/repositories/firebase_group_repository.dart):318
- ⚠️ **בעלים עוזב** - חייב להעביר בעלות קודם
- ⚠️ **התראות Push** - אין FCM, רק in-app

### ראה גם:
- [GAPS-AND-FIXES.md](./GAPS-AND-FIXES.md) - פערים ותיקונים נדרשים

---

## 🔗 קישורים בין מסכים

```
MainNavigationScreen
       │
  Tab 2: קבוצות
       ↓
 GroupsListScreen
       │
       ├── "+ צור קבוצה" → CreateGroupScreen
       │
       └── לחיצה על קבוצה → GroupDetailsScreen
                              │
                              ├── "הזמן חברים"
                              └── "הגדרות קבוצה"
```

---

## 📝 סיכום

קבוצות מאפשרות **שיתוף פעולה** בין אנשים.

**סוגי קבוצות (7):**
- 👨‍👩‍👧‍👦 `family` - משפחה
- 🏢 `building` - ועד בית
- 🎒 `kindergarten` - ועד גן
- 👥 `friends` - חברים
- 🎉 `event` - אירוע
- 🏠 `roommates` - שותפים לדירה
- 📋 `other` - אחר

**תפקידים (4):**
- `owner` - בעלים (יכול למחוק)
- `admin` - מנהל
- `editor` - עורך
- `viewer` - צופה

**תהליך:**
1. יוגב יוצר קבוצה (בוחר סוג ושם)
2. מזמין חברים
3. החברים מאשרים
4. כולם רואים את אותן רשימות
