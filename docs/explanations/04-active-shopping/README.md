# 📱 קניה פעילה

## 🎯 מה זה עושה?

מסך "קנייה פעילה" הוא המסך שיוגב רואה כשהוא **בתוך החנות** וקונה.
המסך מציג:
- ⏱️ טיימר - כמה זמן עובר מתחילת הקניה
- 📊 מונים - כמה נקנה, כמה נשאר, כמה לא היה
- רשימת המוצרים לפי קטגוריות
- אפשרות לסמן כל מוצר: נקנה / לא במלאי / לא צריך

---

## 🔄 זרימה - קניה פעילה

```
┌─────────────────────────────────────────────────────────┐
│  יוגב נכנס לרשימה ולוחץ "התחל קנייה"                   │
└──────────────────────┬──────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────────┐
│  נפתח מסך קנייה פעילה                                   │
│  • הטיימר מתחיל לרוץ: 00:00                             │
│  • כל המוצרים מוצגים לפי קטגוריה                        │
└──────────────────────┬──────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────────┐
│  יוגב עובר בין המוצרים:                                │
│                                                         │
│  🛒 לחץ שמאלה = "נקנה" ✅                               │
│  ❌ לחץ ימינה = "לא במלאי"                              │
│  ⏭️ לחץ למטה = "לא צריך" (דילוג)                       │
└──────────────────────┬──────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────────┐
│  כשסיים - לוחץ "סיים קניה"                              │
└──────────────────────┬──────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────────┐
│  מסך סיכום קנייה:                                       │
│  • סה"כ זמן: 00:35:22                                   │
│  • נקנו: 12 פריטים                                      │
│  • לא היו: 2 פריטים                                     │
│  • דילגתי: 1 פריט                                       │
│  • סכום כולל: ₪234.50                                   │
└──────────────────────┬──────────────────────────────────┘
                       ↓
              נוצרת "קבלה" בהיסטוריה
```

---

## 📖 דוגמה - יוגב הולך לסופר

**הסיטואציה:** יוגב יוצא לסופר עם רשימה של 15 מוצרים

**מה יוגב עושה:**
1. פותח את הרשימה "קניות לסופ"ש"
2. לוחץ "התחל קנייה"
3. הטיימר מתחיל: 00:00:00

**במהלך הקנייה:**
```
יוגב מגיע לחלב
   → מוצא אותו → מחליק שמאלה → ✅ נקנה

יוגב מגיע לגבינה צהובה מסוימת
   → אין במלאי → מחליק ימינה → ❌ לא במלאי

יוגב רואה "עוגיות" ברשימה
   → החליט לא לקנות → מחליק למטה → ⏭️ לא צריך
```

**בסוף הקנייה:**
1. יוגב לוחץ "סיים קנייה"
2. רואה סיכום עם זמן וכמויות
3. האפליקציה יוצרת "קבלה וירטואלית"
4. המזווה מתעדכן אוטומטית

---

## 📱 איך נראה המסך

```
┌─────────────────────────────────────────────────────────┐
│  ← קניות לסופ"ש                          ⏱️ 00:15:32  │
├─────────────────────────────────────────────────────────┤
│  ✅ נקנו: 8    │    ⏳ נותרו: 5    │    ❌ חסר: 2     │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  🥛 מוצרי חלב                                          │
│  ┌────────────────────────────────────────────────────┐│
│  │ ← 📦 חלב 3%                           ₪7.90    → ││
│  │    החלק שמאלה: נקנה | ימינה: לא במלאי           ││
│  └────────────────────────────────────────────────────┘│
│                                                         │
│  ✅ גבינה צהובה                          ₪22.00        │
│  ✅ יוגורט                               ₪5.50         │
│                                                         │
│  🥬 ירקות                                              │
│  ┌────────────────────────────────────────────────────┐│
│  │ ← 📦 עגבניות                          ₪8.00    → ││
│  └────────────────────────────────────────────────────┘│
│                                                         │
├─────────────────────────────────────────────────────────┤
│               [ 🏁 סיים קנייה ]                        │
└─────────────────────────────────────────────────────────┘
```

---

## 🏷️ סטטוסים של מוצרים

| סטטוס | סמל | מה זה אומר | צבע | מופיע בקבלה? |
|-------|-----|-----------|-----|--------------|
| ממתין | ⏳ | עוד לא טיפלתי בו | רגיל | לא |
| נקנה | ✅ | קניתי אותו | ירוק | כן |
| לא במלאי | ❌ | לא היה בחנות | כתום | כן (עם סימון "חסר") |
| לא צריך | ⏭️ | החלטתי לא לקנות | אפור | לא |

---

## 🔐 הרשאות בקנייה

| תפקיד | להיכנס למסך | להתחיל קנייה | לסמן פריטים | לסיים קנייה |
|-------|-------------|--------------|-------------|-------------|
| בעלים | ✅ כן | ✅ כן | ✅ כן | ✅ כן (אם הוא התחיל) |
| מנהל | ✅ כן | ✅ כן | ✅ כן | ✅ כן (אם הוא התחיל) |
| עורך | ✅ כן | ❌ לא | ✅ כן | ❌ לא |
| צופה | ❌ לא | ❌ לא | ❌ לא | ❌ לא |

**חשוב:** צופה לא יכול להיכנס למסך קנייה בכלל!

---

## 👥 קנייה משותפת

כששני אנשים רוצים לקנות מאותה רשימה באותו זמן:

**הזרימה:**
1. יוגב לוחץ "התחל קנייה" → הופך ל"מתחיל" (Starter)
2. שרה רואה "קנייה פעילה" ולוחצת "הצטרף"
3. יוגב מקבל בקשה → מאשר או דוחה
4. אם אישר → שניהם רואים ומסמנים בזמן אמת
5. רק יוגב (המתחיל) יכול לסיים את הקנייה

**מגבלות:**
- מקסימום 5 משתתפים בקנייה אחת
- המתחיל יכול להסיר משתתף אם צריך

**מה קורה אם המתחיל עוזב?**
- הקנייה ממשיכה - אחרים יכולים להמשיך לסמן
- לא ניתן לסיים עד שהמתחיל חוזר (או timeout 6 שעות)

**איך זה נראה:**

```
┌─────────────────────────────────────────────────────────┐
│  ← קניות לסופ"ש                          ⏱️ 00:15:32  │
├─────────────────────────────────────────────────────────┤
│  👥 קונים עכשיו: יוגב (מתחיל), שרה                      │
├─────────────────────────────────────────────────────────┤
│  ✅ נקנו: 8    │    ⏳ נותרו: 5    │    ❌ חסר: 2     │
│  ...                                                    │
└─────────────────────────────────────────────────────────┘
```

**מה קורה בזמן אמת:**
- שרה מסמנת "חלב" → מיד מופיע ✅ אצל יוגב
- הכל מסתנכרן אוטומטית

---

## ⏸️ יציאה באמצע קנייה

**מה קורה אם יוגב סוגר את האפליקציה?**
- הסימונים נשמרים אוטומטית (כל 300ms)
- הקנייה נשארת "פעילה"

**כשיוגב חוזר לאפליקציה:**
- מופיע banner: "יש לך קנייה פעילה - להמשיך?"
- לוחץ → חוזר למסך קנייה עם כל הסימונים

**אחרי 6 שעות ללא פעילות:**
- הסשן מתנקה אוטומטית
- הסימונים על הפריטים נשארים!
- כשחוזר → "להמשיך מאיפה שנעצר או להתחיל מחדש?"

---

## 📶 טיפול במצב ללא אינטרנט

**מה קורה:**
1. אין אינטרנט? → הודעה "אין חיבור לאינטרנט"
2. הסימונים שכבר עשית נשמרים מקומית
3. לא ניתן לסיים קנייה עד שיש חיבור
4. כשהאינטרנט חוזר → הכל מסתנכרן אוטומטית

**למה?**
- הסימונים חשובים - לא רוצים לאבד אותם
- אבל לסיים קנייה צריך אינטרנט כדי ליצור קבלה

---

## 💾 איפה המידע נשמר?

### קבצים ותפקידים

| קובץ | מה הוא עושה? |
|------|-------------|
| [active_shopping_screen.dart](../../../lib/screens/shopping/active/active_shopping_screen.dart) | מסך הקנייה הפעילה |
| [shopping_lists_provider.dart](../../../lib/providers/shopping_lists_provider.dart) | מעדכן את הרשימה |
| [receipt_provider.dart](../../../lib/providers/receipt_provider.dart) | יוצר קבלה בסוף |
| [inventory_provider.dart](../../../lib/providers/inventory_provider.dart) | מעדכן את המזווה |

### מה מתעדכן ב-Firebase?

**בזמן הקנייה:**
```
shopping_lists/רשימה_id/items/פריט_id:
  is_checked: true  // כשמסמנים "נקנה"
  checked_by: "יוגב_id"
  checked_at: timestamp
```

**בסוף הקנייה (קבלה):**
```
receipts/קבלה_id:
  store_name: "סופרמרקט"
  date: timestamp
  total_amount: 234.50
  is_virtual: true
  shopping_duration: 2132  // שניות
  items: [...]
```

---

## ⚠️ דברים לבדוק

### עובד:
- ✅ טיימר רץ ברקע
- ✅ סימון מוצרים (החלקה)
- ✅ מונים מתעדכנים בזמן אמת
- ✅ יצירת קבלה בסיום
- ✅ עדכון המזווה

### צריך להוסיף/לתקן:
- ⚠️ **הרשאות** - צופה לא צריך להיכנס למסך קנייה (באג!)
- ⚠️ **קנייה משותפת** - מנגנון הצטרפות ואישור
- ⚠️ **יציאה באמצע** - שמירת סימונים + banner "להמשיך?"
- ⚠️ **timeout 6 שעות** - ניקוי סשן אוטומטי
- ⚠️ **אין אינטרנט** - הודעה + שמירה מקומית
- ⚠️ **עדכון בזמן אמת** - לקנייה משותפת

### ראה גם:
- [GAPS-AND-FIXES.md](./GAPS-AND-FIXES.md) - פערים ותיקונים נדרשים

---

## 🔗 קישורים בין מסכים

```
ShoppingListDetailsScreen
          │
    "התחל קנייה"
          ↓
   ActiveShoppingScreen
          │
    "סיים קנייה"
          ↓
  ShoppingSummaryScreen
          │
      "סגור"
          ↓
    HomeDashboard
```

---

## 📝 סיכום

מסך קנייה פעילה הוא הכלי לשימוש **בזמן הקנייה בחנות**.

**תהליך:**
1. התחל קנייה (הטיימר מתחיל)
2. עבור על כל מוצר - סמן נקנה/חסר/לא צריך
3. סיים קנייה
4. צפה בסיכום
5. הכל נשמר אוטומטית

**המידע זורם:**
```
יוגב (בחנות) → ActiveShoppingScreen → ShoppingListsProvider → Firebase
                                              ↓
                                      ReceiptProvider (קבלה)
                                              ↓
                                      InventoryProvider (מזווה)
```
