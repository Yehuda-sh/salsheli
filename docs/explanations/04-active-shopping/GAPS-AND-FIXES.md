# פערים ותיקונים נדרשים - קנייה פעילה

מסמך זה מפרט את הפערים שנמצאו בין האיפיון לקוד הקיים.

---

## סיכום פערים

| נושא | באיפיון | בקוד | מה צריך לעשות |
|------|---------|------|---------------|
| הרשאות | מוגדר | אין בדיקה (באג!) | להוסיף בדיקה לפני כניסה |
| קנייה משותפת | מוגדר | לא מומש | לממש מנגנון הצטרפות |
| יציאה באמצע | מוגדר | חלקי | להוסיף banner "להמשיך?" |
| timeout 6 שעות | מוגדר | קיים במודל | לוודא שעובד |
| אין אינטרנט | מוגדר | לא מטופל | להוסיף הודעה |
| עדכון בזמן אמת | מוגדר | לא מומש לקנייה משותפת | להוסיף StreamBuilder |

---

## החלטות שהתקבלו

### 1. הרשאות בקנייה

| תפקיד | להיכנס | להתחיל | לסמן | לסיים |
|-------|--------|--------|------|-------|
| בעלים | כן | כן | כן | כן (אם התחיל) |
| מנהל | כן | כן | כן | כן (אם התחיל) |
| עורך | כן | לא | כן | לא |
| צופה | **לא** | לא | לא | לא |

**באג נוכחי:** צופה יכול להיכנס ולסמן פריטים!

---

### 2. קנייה משותפת

**הזרימה:**
1. מי שלוחץ "התחל קנייה" = "מתחיל" (Starter)
2. אחרים יכולים לבקש להצטרף
3. המתחיל מאשר/דוחה בקשות
4. כולם מסמנים בזמן אמת
5. רק המתחיל יכול לסיים

**מגבלות:**
- מקסימום 5 משתתפים בקנייה אחת

**תרחישי קצה:**

| תרחיש | מה קורה |
|-------|---------|
| המתחיל עוזב באמצע | הקנייה ממשיכה, אחרים מסמנים, אבל לא ניתן לסיים עד שהמתחיל חוזר (או timeout 6 שעות) |
| המתחיל רוצה להסיר מישהו | כן, יכול - המתחיל אחראי על הקנייה |
| בקשת הצטרפות תלויה כשסיימו | נדחית אוטומטית |

**מה צריך לממש:**
- כפתור "הצטרף לקנייה"
- מנגנון בקשות ואישורים
- הצגת "מי קונה עכשיו"
- עדכון בזמן אמת בין כל הקונים
- כפתור "הסר משתתף" למתחיל

---

### 3. מי מסיים קנייה

**ההחלטה:** רק מי שהתחיל ("המתחיל") יכול לסיים

**למה?**
- מונע בלבול
- המתחיל אחראי על הקנייה
- אם המתחיל רוצה לתת לאחר לסיים - צריך לממש "העברת ניהול"

---

### 4. "לא צריך" לעומת "לא במלאי"

| סטטוס | משמעות | מופיע בקבלה? |
|-------|--------|--------------|
| לא במלאי | המוצר לא היה בחנות | כן - עם סימון "חסר" |
| לא צריך | החלטתי לא לקנות | לא |

**הסבר:**
- "לא במלאי" חשוב לתיעוד - כדי לדעת שהמוצר נדרש אבל לא היה
- "לא צריך" זו החלטה של המשתמש - לא רלוונטי לקבלה

---

### 5. יציאה באמצע קנייה

**מה קורה:**
- סימונים נשמרים אוטומטית (כל 300ms)
- הקנייה נשארת "פעילה"
- כשחוזרים → banner "יש לך קנייה פעילה - להמשיך?"

**timeout 6 שעות:**
- אחרי 6 שעות ללא פעילות → הסשן מתנקה
- הסימונים נשארים על הפריטים!
- כשחוזרים → "להמשיך מאיפה שנעצר או להתחיל מחדש?"

---

### 6. אין אינטרנט

**מה צריך לקרות:**
1. הודעה "אין חיבור לאינטרנט"
2. סימונים נשמרים מקומית
3. לא ניתן לסיים קנייה (צריך לסנכרן)
4. כשהאינטרנט חוזר → סנכרון אוטומטי

---

## סדר עדיפויות לתיקון

### עדיפות גבוהה (באגים)
| # | מה לתקן | קובץ |
|---|---------|------|
| 1 | צופה לא יכנס למסך קנייה | `active_shopping_screen.dart` |
| 2 | banner "יש לך קנייה פעילה" | `home_dashboard_screen.dart` |

### עדיפות בינונית (פונקציונליות חסרה)
| # | מה להוסיף | קובץ |
|---|-----------|------|
| 3 | הודעת "אין אינטרנט" | `active_shopping_screen.dart` |
| 4 | קנייה משותפת - מנגנון הצטרפות | `active_shopping_screen.dart`, `shopping_list.dart` |
| 5 | עדכון בזמן אמת בקנייה משותפת | `active_shopping_screen.dart` |

### עדיפות נמוכה (שיפורים)
| # | מה להוסיף | קובץ |
|---|-----------|------|
| 6 | הודעה "להמשיך מאיפה שנעצר" אחרי timeout | `home_dashboard_screen.dart` |

---

## קבצים עיקריים לשינוי

| קובץ | מה לשנות |
|------|----------|
| `lib/screens/shopping/active/active_shopping_screen.dart` | הרשאות, offline, קנייה משותפת |
| `lib/screens/home/home_dashboard_screen.dart` | banner קנייה פעילה |
| `lib/models/shopping_list.dart` | שדות לקנייה משותפת |
| `lib/providers/shopping_lists_provider.dart` | לוגיקה לקנייה משותפת |

---

## סיכום

מסמך זה מסכם את כל הפערים שנמצאו במסך קנייה פעילה.
הבאג הכי קריטי: **צופה יכול להיכנס ולסמן פריטים** - זה צריך להיות מתוקן ראשון!

**תאריך עדכון אחרון:** ינואר 2026
