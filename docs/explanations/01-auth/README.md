# 📱 מסכי הרשמה והתחברות

## 🎯 מה זה עושה?

אלה המסכים הראשונים שמשתמש חדש רואה באפליקציה.
הם מאפשרים למשתמש:
- ליצור חשבון חדש (הרשמה)
- להיכנס לחשבון קיים (התחברות)
- להתחבר דרך Google או Apple
- לאפס סיסמה שנשכחה

---

## 🎉 מסך Welcome - מה יוגב רואה בפעם הראשונה?

כשיוגב מתקין את האפליקציה ופותח אותה **בפעם הראשונה**:

```
┌─────────────────────────────────────────────────────────┐
│  יוגב מתקין ופותח את האפליקציה                          │
└──────────────────────┬──────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────────┐
│  IndexScreen בודק:                                      │
│  • האם מחובר? → לא                                      │
│  • האם ראה Welcome בעבר? → לא (seenOnboarding=false)    │
└──────────────────────┬──────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────────┐
│  🎉 WelcomeScreen - מסך קבלת פנים                       │
│                                                         │
│  • שם האפליקציה וסלוגן                                  │
│  • 3 כרטיסי דוגמה עם Mini UI:                          │
│    - 👨‍👩‍👧‍👦 משפחה - רשימת קניות                          │
│    - 🏠 ועד בית - הצבעות                                │
│    - 🎒 ועד גן - חלוקת משימות                           │
│  • כפתור "בואו נתחיל!" → הרשמה                         │
│  • לינק "יש לי חשבון? להתחבר" → התחברות                │
│  • לינקים לתנאי שימוש ופרטיות                          │
└──────────────────────┬──────────────────────────────────┘
                       ↓
         ┌─────────────┴─────────────┐
         ↓                           ↓
   לוחץ "בואו נתחיל!"         לוחץ "יש לי חשבון"
         ↓                           ↓
┌────────────────┐           ┌────────────────┐
│ register_screen│           │  login_screen  │
└────────────────┘           └────────────────┘
```

### קובץ:
| קובץ | מה הוא עושה? |
|------|-------------|
| [welcome_screen.dart](../../../lib/screens/welcome/welcome_screen.dart) | מסך קבלת פנים למשתמש חדש - מציג את האפליקציה וכפתורי הרשמה/התחברות |
| [index_screen.dart](../../../lib/screens/index_screen.dart) | "שומר הסף" - מחליט לאן לנווט לפי מצב המשתמש |

---

## 📋 מסך Onboarding - איסוף העדפות (🚧 פיתוח עתידי)

> **סטטוס:** המסך קיים בקוד אבל **לא פעיל** בזרימה הנוכחית.
> כרגע המשתמש עובר ישירות מ-Welcome להרשמה.

**בעתיד**, יוגב יראה מסך Onboarding שאוסף העדפות:

```
┌─────────────────────────────────────────────────────────┐
│  📋 ספר לנו קצת על עצמך                                │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  👨‍👩‍👧‍👦 כמה נפשות במשפחה?     [2] [3] [4] [5+]          │
│                                                         │
│  🛒 איפה אתם קונים?                                    │
│     ☑ שופרסל   ☑ רמי לוי   ☐ יוחננוף                  │
│     ☐ סופר פארם   ☐ אושר עד   ☐ ויקטורי              │
│                                                         │
│  📅 כמה פעמים בשבוע?         [1] [2] [3]              │
│                                                         │
│  🗓️ באיזה ימים?                                        │
│     ☑ ראשון   ☐ שני   ☐ שלישי   ☑ חמישי              │
│                                                         │
│  👶 יש ילדים?                 [כן] [לא]                │
│                                                         │
│  ⏰ שעת תזכורת מועדפת?        [09:00]                  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### מה נאסף?

| העדפה | שדה | שימוש |
|-------|-----|-------|
| גודל משפחה | `familySize` | התאמת כמויות ברשימות |
| חנויות מועדפות | `preferredStores` | הצעות חכמות, סידור לפי חנות |
| תדירות קניות | `shoppingFrequency` | תזכורות |
| ימי קניות | `shoppingDays` | תזכורות |
| יש ילדים | `hasChildren` | מוצרי ילדים, קטגוריות |
| פרטי ילדים | `children` | מוצרים לפי גיל |
| שיתוף רשימות | `shareLists` | ברירת מחדל לשיתוף |
| שעת תזכורת | `reminderTime` | התראות |

### איפה נשמר?

- **מקומית:** SharedPreferences (עם prefix `onboarding.*`)
- **בענן:** מסונכרן ל-Firebase ב-UserEntity

### קבצים:
| קובץ | מה הוא עושה? |
|------|-------------|
| [onboarding_screen.dart](../../../lib/screens/onboarding/onboarding_screen.dart) | מסך איסוף ההעדפות |
| [onboarding_data.dart](../../../lib/data/onboarding_data.dart) | מודל נתונים + שמירה/טעינה |
| [onboarding_service.dart](../../../lib/services/onboarding_service.dart) | לוגיקת שמירה וסנכרון |

---

## 🔄 זרימת הרשמה - מה קורה כשיוגב נרשם?

```
┌─────────────────────────────────────────────────────────┐
│  יוגב ב-WelcomeScreen לוחץ "בואו נתחיל!"                │
│  (או: יוגב ב-LoginScreen לוחץ "צור חשבון חדש")          │
└──────────────────────┬──────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────────┐
│  יוגב ממלא את הטופס:                                    │
│  • שם: יוגב כהן                                         │
│  • אימייל: yogev@gmail.com                              │
│  • סיסמה: 123456                                        │
│  • אישור סיסמה: 123456                                  │
│  • טלפון: 050-1234567                                   │
└──────────────────────┬──────────────────────────────────┘
                       ↓
         ┌─────────────┴─────────────┐
         ↓                           ↓
    [הכל תקין]                  [יש שגיאה]
         ↓                           ↓
    האפליקציה שולחת           הטופס רועד
    ל-Firebase                ומציג הודעה
         ↓                    "סיסמה קצרה מדי"
         ↓                    או "אימייל לא תקין"
┌────────┴────────┐
↓                 ↓
[הצלחה]        [נכשל]
↓                 ↓
נוצר משתמש     "האימייל כבר
ב-Firebase     קיים במערכת"
↓
נוצר "בית" (household)
חדש בשביל יוגב
↓
בודק אם יש הזמנות
לקבוצות שמחכות ליוגב
↓
עובר ל-OnboardingScreen
(איסוף העדפות)
↓
┌────────┴────────┐
↓                 ↓
[יש הזמנות]    [אין הזמנות]
↓                 ↓
"יש לך 2        עובר ישר
הזמנות!         לדף הבית
האם לראות?"
```

---

## 🔄 זרימת התחברות - מה קורה כשיוגב חוזר?

```
┌─────────────────────────────────────────────────────────┐
│  יוגב פותח את האפליקציה (כבר נרשם בעבר)                 │
└──────────────────────┬──────────────────────────────────┘
                       ↓
┌─────────────────────────────────────────────────────────┐
│  הוא ממלא אימייל וסיסמה ולוחץ "התחבר"                   │
└──────────────────────┬──────────────────────────────────┘
                       ↓
         ┌─────────────┴─────────────┐
         ↓                           ↓
    [הצלחה]                     [נכשל]
         ↓                           ↓
    "התחברת בהצלחה!"            "משתמש לא קיים"
         ↓                      או "סיסמה שגויה"
    עובר לדף הבית
```

---

## 📖 דוגמה מפורטת - יוגב נרשם לאפליקציה

**הסיטואציה:** יוגב מוריד את האפליקציה ורוצה להתחיל להשתמש.

**מה יוגב עושה:**
1. פותח את האפליקציה בפעם הראשונה
2. רואה את **מסך Welcome** עם הסבר על האפליקציה
3. לוחץ "בואו נתחיל!" (או "יש לי חשבון? להתחבר" אם כבר נרשם)
4. ממלא:
   - שם: יוגב כהן
   - אימייל: yogev@gmail.com
   - סיסמה: Yogev123!
   - אישור סיסמה: Yogev123!
   - טלפון: 050-1234567
5. לוחץ "הרשמה"

**מה קורה מאחורי הקלעים:**
1. הטופס בודק שהכל תקין (validation)
2. האפליקציה שולחת את הפרטים ל-Firebase Auth
3. Firebase יוצר חשבון חדש ליוגב
4. האפליקציה יוצרת "בית" (household) חדש - `house_abc123`
5. נשמרים ב-Firebase הפרטים של יוגב:
   ```
   users/יוגב_id:
     name: "יוגב כהן"
     email: "yogev@gmail.com"
     phone: "0501234567"
     household_id: "house_abc123"
     joined_at: "2024-01-15"
     is_admin: true  ← יוגב הוא מנהל הבית שלו
   ```
6. יוגב עובר לדף הבית

---

## 📖 דוגמה - יוגב שכח סיסמה

**מה יוגב עושה:**
1. פותח מסך התחברות
2. מכניס את האימייל שלו
3. לוחץ "שכחת סיסמה?"

**מה קורה:**
1. Firebase שולח מייל ליוגב
2. המייל מכיל קישור לאיפוס
3. יוגב לוחץ על הקישור ומגדיר סיסמה חדשה

---

## 💾 איפה המידע נשמר?

### קבצים ותפקידים

| קובץ | מה הוא עושה? |
|------|-------------|
| [register_screen.dart](../../../lib/screens/auth/register_screen.dart) | המסך שמציג את טופס ההרשמה - השדות, הכפתורים, העיצוב |
| [login_screen.dart](../../../lib/screens/auth/login_screen.dart) | המסך שמציג את טופס ההתחברות |
| [auth_service.dart](../../../lib/services/auth_service.dart) | "השליח" - שולח את הבקשות ל-Firebase (הרשמה, התחברות, איפוס סיסמה) |
| [user_context.dart](../../../lib/providers/user_context.dart) | "הזיכרון" - זוכר מי המשתמש המחובר ושומר את הפרטים שלו |
| [user_entity.dart](../../../lib/models/user_entity.dart) | "התבנית" - מגדיר איזה פרטים יש למשתמש (שם, אימייל, טלפון וכו') |

### איך הם עובדים יחד?

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  RegisterScreen │ --> │   UserContext   │ --> │   AuthService   │
│   (מה רואים)    │     │   (מי מחובר)   │     │ (שולח ל-Firebase)│
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                                        ↓
                                                ┌─────────────────┐
                                                │    Firebase     │
                                                │ (מאחסן בענן)    │
                                                └─────────────────┘
```

### מה נשמר ב-Firebase?

**ב-Firebase Auth (מערכת הסיסמאות):**
- אימייל
- סיסמה (מוצפנת)
- מזהה ייחודי (userId)

**ב-Firebase Firestore (מסד הנתונים):**
- שם מלא
- טלפון
- מזהה הבית (householdId)
- תאריך הצטרפות
- האם מנהל
- העדפות (חנויות מועדפות, גודל משפחה וכו')

### מה נשמר בטלפון?

**ב-SharedPreferences (זיכרון מקומי):**
- האם ראה את ה-Onboarding
- מצב ערכת נושא (בהיר/כהה)
- העדפות תצוגה

---

## ⚠️ דברים לבדוק

### בדיקות תקינות (Validation):
- ✅ בדיקת אימייל תקין (מכיל @)
- ✅ בדיקת סיסמה (לפחות 6 תווים)
- ✅ בדיקת טלפון ישראלי (מתחיל ב-05)
- ✅ בדיקת שם (לפחות 2 תווים)
- ✅ בדיקה שסיסמה ואישור סיסמה זהים

### אפשרויות התחברות:
- ✅ אימייל + סיסמה
- ✅ Google Sign-In
- ✅ Apple Sign-In (iOS/macOS)
- ✅ שכחתי סיסמה

### שגיאות שמטופלות:
- ✅ "האימייל כבר קיים"
- ✅ "משתמש לא נמצא"
- ✅ "סיסמה שגויה"
- ✅ "סיסמה חלשה מדי"
- ✅ "יותר מדי ניסיונות - נסה מאוחר יותר"
- ✅ "בעיית רשת"

### מה לא מטופל / דורש שיפור:
- ❌ **Timeout** - אין timeout לפעולות Firebase (הבקשה תחכה דקות עד Socket Timeout)
- ❌ **בדיקת חיבור** - אין בדיקת connectivity לפני הרשמה/התחברות
- ❌ **Retry** - אין ניסיון חוזר אוטומטי בכשל רשת
- ❌ **Offline** - לא ניתן להתחבר ללא אינטרנט (אין local cache)
- ✅ **Rollback** - אם יצירת פרופיל נכשלת, המשתמש נמחק מ-Auth (אין הרשמה חלקית)

---

## ⚠️ קוד בעייתי שנמצא

| בעיה | קובץ | שורות | תיאור |
|------|------|-------|-------|
| TODOs ריקים | [welcome_screen.dart](../../../lib/screens/welcome/welcome_screen.dart) | 190-216 | כפתורי "תנאי שימוש" ו"מדיניות פרטיות" לא עושים כלום |
| API ישנה | [onboarding_screen.dart](../../../lib/screens/onboarding/onboarding_screen.dart) | 126, 163 | משתמש ב-`savePreferences()` ה-deprecated במקום `savePreferencesResult()` |
| מסך לא מחובר | onboarding_screen.dart | - | OnboardingScreen בנוי אך אין לו route ב-main.dart |

---

## 🔗 קישורים בין מסכים

```
             ┌─────────────────┐
             │  index_screen   │  ← נקודת הכניסה לאפליקציה
             └────────┬────────┘
                      ↓
         ┌────────────┴────────────┐
         ↓                         ↓
   [לא מחובר]                 [מחובר]
         ↓                         ↓
         ↓                  ┌────────────────┐
         ↓                  │ home_dashboard │
         ↓                  └────────────────┘
         ↓
   [ראה welcome?]
         ↓
    ┌────┴────┐
    ↓         ↓
  [לא]      [כן]
    ↓         ↓
┌────────────────┐  ┌────────────────┐
│ welcome_screen │  │  login_screen  │
└───────┬────────┘  └───────┬────────┘
        ↓                   ↓
   לוחץ "בואו          לוחץ "הרשמה"
   נתחיל!"                  ↓
        ↓           ┌────────────────┐
        └──────────→│register_screen │
                    └───────┬────────┘
                            ↓
                      הרשמה הצליחה
                            ↓
                    ┌────────────────┐
                    │ home_dashboard │
                    └────────────────┘
```

---

## 🎨 עיצוב מיוחד

המסכים האלה משתמשים בעיצוב "פתקים דביקים" (Sticky Notes):
- כל שדה עטוף בפתק צהוב
- הפתקים מעט מוטים (רוטציה)
- רקע של מחברת עם קווים
- אנימציה של "רעידה" כשיש שגיאה
- כפתורי Google/Apple עם אנימציית כניסה

---

## 📝 סיכום

| פעולה | מה קורה | לאן עוברים |
|-------|---------|-----------|
| הרשמה מוצלחת | נוצר משתמש + בית חדש | דף הבית |
| התחברות מוצלחת | נטען המשתמש הקיים | דף הבית |
| שכחתי סיסמה | נשלח מייל איפוס | נשאר במסך התחברות |
| שגיאה | הודעה + רעידה | נשאר באותו מסך |
