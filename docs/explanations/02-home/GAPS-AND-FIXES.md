# פערים ותיקונים נדרשים - דף הבית ומסך הקנייה

מסמך זה מפרט את הפערים שנמצאו בין האיפיון הקיים לבין מה שצריך להיות, כולל באגים בקוד ותיקונים נדרשים.

---

## סיכום פערים

| נושא | באיפיון | בקוד | מה צריך לעשות |
|------|---------|------|---------------|
| מיון רשימות | לא מוגדר | אין מיון | להוסיף מיון (חדש למעלה ברירת מחדל) |
| טיפול ב-offline | כתוב "לא מטופל" | לא מטופל | להוסיף הודעה למשתמש |
| שגיאות טעינה | לא מוגדר | יש ב-Provider, לא ב-UI | להציג הודעה למשתמש |
| מחיקה מהבית | לא מוגדר | לא קיים | להוסיף מצב עריכה |
| עדכון בזמן אמת | לא מוגדר | רק Pull to Refresh | להוסיף StreamBuilder |
| הרשאות בקנייה | לא מוגדר | **אין בדיקה (באג!)** | להוסיף בדיקות הרשאות |

---

## באגים שנמצאו

### באג 1: צופה יכול להיכנס למסך קנייה ולסמן פריטים

**חומרה:** גבוהה

**מיקום בקוד:**
- `lib/screens/shopping/lists/shopping_lists_screen.dart` - אין בדיקת הרשאות לפני כניסה
- `lib/screens/shopping/active/active_shopping_screen.dart` - אין בדיקת הרשאות לפני סימון

**הבעיה:**
כל משתמש שיש לו גישה לרשימה יכול להיכנס למסך הקנייה ולסמן פריטים, גם אם הוא צופה בלבד.

**הפתרון:**
1. לפני כניסה למסך הקנייה - לבדוק את התפקיד
2. אם צופה - לא לאפשר כניסה בכלל
3. אם עורך - לאפשר כניסה וסימון, אבל לא התחלה/סיום

---

### באג 2: אין הודעה על קנייה פעילה

**חומרה:** בינונית

**מיקום בקוד:**
- `lib/screens/home/dashboard/home_dashboard_screen.dart`

**הבעיה:**
אם המשתמש יצא מהאפליקציה באמצע קנייה וחזר, הוא לא מקבל הודעה שיש לו קנייה פעילה.

**הפתרון:**
להוסיף banner בדף הבית: "יש לך קנייה פעילה - להמשיך?"

---

## הרשאות בקנייה - מה צריך להיות

### טבלת הרשאות מלאה

| תפקיד | להיכנס למסך קנייה | להתחיל קנייה | להצטרף לקנייה | לסמן פריטים | לסיים קנייה |
|-------|-------------------|--------------|---------------|-------------|-------------|
| בעלים | ✅ כן | ✅ כן | ✅ כן | ✅ כן | ✅ כן (אם התחיל) |
| מנהל | ✅ כן | ✅ כן | ✅ כן | ✅ כן | ✅ כן (אם התחיל) |
| עורך | ✅ כן | ❌ לא | ✅ כן | ✅ כן | ❌ לא |
| צופה | ❌ לא | ❌ לא | ❌ לא | ❌ לא | ❌ לא |

### הסבר התפקידים

**בעלים (Owner):**
- יצר את הרשימה
- יכול הכל
- יכול למחוק את הרשימה

**מנהל (Admin):**
- קיבל הרשאות ניהול מהבעלים
- יכול להתחיל ולסיים קנייה
- לא יכול למחוק את הרשימה

**עורך (Editor):**
- יכול לסמן פריטים
- יכול להצטרף לקנייה שמישהו אחר התחיל
- לא יכול להתחיל או לסיים קנייה

**צופה (Viewer):**
- רק קריאה
- לא יכול להיכנס למסך הקנייה בכלל

---

## תרחישים מיוחדים

### קנייה משותפת

**איך זה עובד:**
1. מי שהתחיל = "מתחיל" (Starter)
2. אחרים יכולים לבקש להצטרף
3. המתחיל מאשר/דוחה בקשות
4. כולם רואים סימונים בזמן אמת
5. רק המתחיל יכול לסיים את הקנייה

**דוגמה:**
```
יוגב (בעלים) לוחץ "התחל קנייה"
    ↓
יוגב = Starter (מתחיל)
    ↓
שרה (מנהלת) רוצה להצטרף → שולחת בקשה
    ↓
יוגב רואה popup "שרה רוצה להצטרף - לאשר?"
    ↓
יוגב מאשר → שרה הצטרפה כ-Helper (עוזרת)
    ↓
שניהם רואים סימונים בזמן אמת
    ↓
רק יוגב יכול ללחוץ "סיים קנייה"
```

---

### יציאה באמצע קנייה

**מה קורה:**
1. הסימונים נשמרים לשרת כל 300 מילישניות
2. כשהמשתמש חוזר לאפליקציה → הודעה "יש לך קנייה פעילה - להמשיך?"
3. אם לוחץ כן → חוזר למסך הקנייה עם כל הסימונים

---

### Timeout של 6 שעות

**מה קורה אחרי 6 שעות ללא פעילות:**
1. הסשן (מי קונה עכשיו) מתנקה אוטומטית
2. הסימונים על הפריטים **נשארים**
3. כשחוזרים → שאלה "להמשיך מאיפה שנעצר או להתחיל מחדש?"

**אם בחר "להמשיך":** רואה את הסימונים הקודמים
**אם בחר "מחדש":** כל הסימונים מתאפסים

---

### קנייה משותפת שננטשה

**תרחיש:**
- יוגב התחיל קנייה
- שרה הצטרפה
- שניהם נטשו ועברו 6 שעות

**מה קורה:**
- הסשן מתנקה
- כל אחד מהם יכול להתחיל קנייה חדשה (אם יש לו הרשאה)
- מי שמתחיל ראשון → הופך ל"מתחיל" החדש

---

### תאריך יעד שעבר

**מה צריך לקרות:**
1. סימון אדום "עבר התאריך" ליד הרשימה
2. התראה למשתמש
3. אפשרויות:
   - "ארכב" - להעביר לארכיון
   - "עדכן תאריך" - לקבוע תאריך חדש
4. אם לא עושה כלום 7 ימים → עוברת לארכיון אוטומטית (לא נמחקת!)

---

### רשימה שהגיעה ל-100%

**מה צריך לקרות:**
- כפתור מהיר "סיים קנייה" מופיע ליד הרשימה בדף הבית
- חוסך כניסה לרשימה רק כדי ללחוץ על הכפתור הירוק

**הערה חשובה:**
- רשימה ב-100% לא עוברת אוטומטית להיסטוריה!
- רק כשלוחצים "סיים קנייה" → נוצרת קבלה ועוברת להיסטוריה

---

## סדר עדיפויות לתיקון

### עדיפות גבוהה (באגים)
| # | מה לתקן | קובץ |
|---|---------|------|
| 1 | הרשאות בקנייה - צופה לא יכנס | `active_shopping_screen.dart` |
| 2 | הודעה על קנייה פעילה | `home_dashboard_screen.dart` |

### עדיפות בינונית (פונקציונליות חסרה)
| # | מה להוסיף | קובץ |
|---|-----------|------|
| 3 | עדכון בזמן אמת לרשימות | `shopping_lists_provider.dart` |
| 4 | הודעה על אין אינטרנט | `home_dashboard_screen.dart` |
| 5 | הצגת שגיאות למשתמש | `home_dashboard_screen.dart` |

### עדיפות נמוכה (שיפורים)
| # | מה להוסיף | קובץ |
|---|-----------|------|
| 6 | מיון רשימות | `home_dashboard_screen.dart` |
| 7 | מצב עריכה בדף הבית | `home_dashboard_screen.dart` |
| 8 | כפתור היסטוריה קבוע | `home_dashboard_screen.dart` |
| 9 | טיפול בתאריך יעד שעבר | `shopping_lists_provider.dart` |
| 10 | כפתור "סיים קנייה" לרשימה 100% | `home_dashboard_screen.dart` |

---

## קבצים עיקריים לשינוי

| קובץ | מה לשנות |
|------|----------|
| `lib/screens/home/dashboard/home_dashboard_screen.dart` | מיון, כפתור היסטוריה, מצב עריכה, banner קנייה פעילה, שגיאות, offline |
| `lib/screens/shopping/active/active_shopping_screen.dart` | בדיקת הרשאות |
| `lib/screens/shopping/lists/shopping_lists_screen.dart` | בדיקת הרשאות לפני כניסה |
| `lib/providers/shopping_lists_provider.dart` | עדכון בזמן אמת, טיפול בתאריך יעד |

---

## הזמנות ממתינות

**מה זה?**
הזמנה להצטרף לקבוצה או רשימה משותפת.

**כמה זמן נשארת?**
30 יום. אחרי זה נמחקת אוטומטית.

**האם נשארת אחרי התנתקות?**
כן! ההזמנות נשמרות בשרת, לא במכשיר.

---

## סיכום

מסמך זה מסכם את כל הפערים שנמצאו בין האיפיון לקוד הקיים.
יש לעדכן את הקוד לפי סדר העדיפויות שהוגדר למעלה.

**תאריך עדכון אחרון:** ינואר 2026
