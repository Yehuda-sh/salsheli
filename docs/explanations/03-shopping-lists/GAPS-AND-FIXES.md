# פערים ותיקונים נדרשים - רשימות קניות

מסמך זה מפרט את הפערים שנמצאו בין האיפיון הקיים לבין מה שצריך להיות, כולל באגים בקוד ותיקונים נדרשים.

---

## סיכום פערים

| נושא | באיפיון | בקוד | מה צריך לעשות |
|------|---------|------|---------------|
| עריכה בו-זמנית | לא מטופל | לא מטופל | בסדר - Last-Write-Wins |
| הגבלת פריטים | לא מוגדר | אין הגבלה | להוסיף מקסימום 200 |
| עדכון בזמן אמת | לא מוגדר | רק Provider | להוסיף StreamBuilder |
| אין אינטרנט | חלקי | לא מטופל | להציג הודעה ולחסום עריכה |
| מצב "מי מביא מה" | מוזכר | לא מומש | לממש את הפיצ'ר |
| כפתור קיבוץ | לא מוגדר | אוטומטי מעל 10 | להוסיף כפתור toggle |

---

## החלטות שהתקבלו

### 1. עריכה בו-זמנית (Concurrent Editing)

**ההחלטה:** Last-Write-Wins - האחרון ששומר "מנצח"

**הסבר:**
- אם יוגב ושרה עורכים את אותו מוצר באותו זמן, מי ששמר אחרון - זה מה שיישמר
- זה מקובל - במקרים רגילים זה לא יקרה הרבה
- לא צריך לפתח מנגנון נעילה מורכב

---

### 2. הגבלת פריטים ברשימה

**ההחלטה:** מקסימום 200 פריטים ברשימה

**הסיבות:**
- למניעת שימוש לא הולם (ספאם)
- שמירה על ביצועים טובים
- 200 זה יותר ממספיק לכל סוג קנייה

**מה צריך לממש:**
- בדיקה לפני הוספת פריט
- אם יש 200 → הודעה "הגעת למקסימום"
- לא לאפשר הוספה נוספת

**קבצים לשנות:**
- `lib/providers/shopping_lists_provider.dart` - בדיקה ב-`addItemToList`

---

### 3. סימון מוצר שנקנה

**ההחלטה:** המוצר נשאר במקום עם קו חוצה

**מה עובד:** ✅ הקוד כבר עושה את זה נכון

---

### 4. מחיקת פריט

**ההחלטה:** אישור + אפשרות ביטול (5 שניות)

**מה עובד:** ✅ הקוד כבר עושה את זה נכון

---

### 5. עדכון בזמן אמת

**ההחלטה:** חובה לרשימות משותפות!

**מצב נוכחי:** הקוד משתמש ב-`context.watch<ShoppingListsProvider>()` - לא real-time

**מה צריך לממש:**
- StreamBuilder ישירות מ-Firebase
- כל שינוי שמישהו עושה מופיע מיד לכולם

**קבצים לשנות:**
- `lib/screens/shopping/details/shopping_list_details_screen.dart`
- `lib/providers/shopping_lists_provider.dart`

---

### 6. הרשאות עורך - בקשות לאישור

**ההחלטה:** עורך שולח בקשה, בעלים/מנהל מאשר

**מה עובד:** ✅ יש מנגנון בקשות בקוד

**מה צריך לשפר:**
- להציג בקשות ממתינות ברשימה עצמה (לא רק במסך נפרד)
- כפתורי אישור/דחייה מהירים
- אם לא טופל עד סיום קנייה → לא בקבלה
- אם אושר וקנו → בקבלה עם "נוסף ע"י [שם]"

**קבצים לשנות:**
- `lib/screens/shopping/details/shopping_list_details_screen.dart`
- `lib/widgets/common/pending_requests_section.dart`

---

### 7. מצב "מי מביא מה" (לאירועים)

**ההחלטה:**
- כל משתתף יכול לסמן פריט שהוא מביא
- ליד הפריט מופיע שם מי שסימן (פשוט - רק השם)
- פריטים שאף אחד לא סימן = ריק (פנוי)
- בעלים/מנהל יכולים לנעול את הרשימה

**מצב נוכחי:** לא מומש

**מה צריך לממש:**
1. שדה `claimed_by` בכל פריט
2. UI להצגת השם ליד הפריט
3. אפשרות ללחוץ ולסמן "אני מביא"
4. אפשרות לבטל את הסימון
5. כפתור "נעל רשימה" לבעלים/מנהל
6. אחרי נעילה - לא ניתן לשנות

**קבצים לשנות:**
- `lib/models/unified_list_item.dart` - להוסיף `claimedBy`
- `lib/screens/shopping/details/shopping_list_details_screen.dart` - UI
- `lib/models/shopping_list.dart` - להוסיף `isLocked`

---

### 8. קיבוץ לפי קטגוריות

**ההחלטה:** כפתור הפעלה/כיבוי - המשתמש יבחר

**מצב נוכחי:** קיבוץ אוטומטי מעל 10 פריטים

**מה צריך לממש:**
- כפתור toggle בראש הרשימה
- שמירת ההעדפה (SharedPreferences או Firebase)
- ברירת מחדל: מעל 10 = מופעל

**קבצים לשנות:**
- `lib/screens/shopping/details/shopping_list_details_screen.dart`

---

### 9. טיפול במצב ללא אינטרנט

**ההחלטה:** להציג הודעה ולחסום עריכה

**מצב נוכחי:** לא מטופל

**מה צריך לממש:**
1. לזהות מצב offline (connectivity_plus)
2. להציג banner "אין חיבור לאינטרנט"
3. לחסום עריכה (כפתורי הוספה/עריכה מושבתים)
4. להציג את הנתונים מ-cache (לקריאה בלבד)
5. כשהאינטרנט חוזר - banner נעלם, עריכה מתאפשרת

**קבצים לשנות:**
- `lib/screens/shopping/details/shopping_list_details_screen.dart`
- אולי: ליצור widget משותף לבדיקת connectivity

---

### 10. תבניות

**ההחלטה:**
- התבניות הן רק הצעות למוצרים
- לא ניתן ליצור תבניות אישיות
- כשבוחרים תבנית → מופיעות הצעות בראש הרשימה

**מה עובד:** ✅ יש מערכת תבניות בסיסית

**TODO לעתיד - תבניות נוספות:**
- 🕯️ שבת
- 🧺 פיקניק
- 🍳 ארוחת בוקר חגיגית
- 🎈 מסיבת ילדים
- 🎒 חזרה לבית ספר

---

## סדר עדיפויות לתיקון

### עדיפות גבוהה (פונקציונליות חסרה)
| # | מה לתקן | קובץ |
|---|---------|------|
| 1 | עדכון בזמן אמת לרשימות משותפות | `shopping_list_details_screen.dart` |
| 2 | הודעה כשאין אינטרנט | `shopping_list_details_screen.dart` |
| 3 | הגבלת 200 פריטים | `shopping_lists_provider.dart` |

### עדיפות בינונית
| # | מה להוסיף | קובץ |
|---|-----------|------|
| 4 | מצב "מי מביא מה" | `shopping_list_details_screen.dart`, `unified_list_item.dart` |
| 5 | הצגת בקשות ממתינות ברשימה | `shopping_list_details_screen.dart` |
| 6 | כפתור toggle לקיבוץ קטגוריות | `shopping_list_details_screen.dart` |

### עדיפות נמוכה (שיפורים)
| # | מה להוסיף | קובץ |
|---|-----------|------|
| 7 | תבניות נוספות | `assets/templates/` |

---

## קבצים עיקריים לשינוי

| קובץ | מה לשנות |
|------|----------|
| `lib/screens/shopping/details/shopping_list_details_screen.dart` | עדכון בזמן אמת, offline, toggle קיבוץ, מי מביא מה |
| `lib/providers/shopping_lists_provider.dart` | הגבלת 200 פריטים, StreamBuilder |
| `lib/models/unified_list_item.dart` | שדה `claimedBy` למי מביא מה |
| `lib/models/shopping_list.dart` | שדה `isLocked` לנעילת רשימה |
| `lib/widgets/common/pending_requests_section.dart` | שיפור הצגת בקשות |

---

## סיכום

מסמך זה מסכם את כל הפערים שנמצאו בין האיפיון לקוד הקיים.
יש לעדכן את הקוד לפי סדר העדיפויות שהוגדר למעלה.

**תאריך עדכון אחרון:** ינואר 2026
