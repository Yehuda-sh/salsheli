rules_version = '2';

// ğŸ”’ MemoZap Firestore Security Rules
//
// âœ… ×¢×•×“×›×Ÿ: Phase 6 - Nested Subcollections Structure
// ğŸ“… Last Updated: 14/12/2025
//
// ğŸ—ï¸ Database Structure:
//
//    users/{userId}/
//    â”œâ”€â”€ private_lists/{listId}      â† ×¨×©×™××•×ª ×¤×¨×˜×™×•×ª
//    â”œâ”€â”€ notifications/{notifId}
//    â”œâ”€â”€ pending_invites/{inviteId}
//    â””â”€â”€ saved_contacts/{contactId}
//
//    households/{householdId}/
//    â”œâ”€â”€ info                        â† ××™×“×¢ ×¢×œ ××©×§ ×”×‘×™×ª
//    â”œâ”€â”€ members/{memberId}
//    â”œâ”€â”€ inventory/{itemId}          â† ××œ××™ ××©×•×ª×£
//    â”œâ”€â”€ receipts/{receiptId}        â† ×§×‘×œ×•×ª
//    â”œâ”€â”€ shared_lists/{listId}       â† ×¨×©×™××•×ª ××©×•×ª×¤×•×ª
//    â”œâ”€â”€ invites/{inviteId}
//    â””â”€â”€ join_requests/{requestId}
//
// ğŸ“„ ××¢×¨×›×ª ×”×¨×©××•×ª ×œ×¨×©×™××•×ª ××©×•×ª×¤×•×ª (Map-Based):
//    ×‘××§×•× ××¢×¨×š, ××©×ª××©×™× ×‘××¤×”: shared_users = { "uid": { role: "..." } }
//    ×–×” ×××¤×©×¨ ×‘×“×™×§×•×ª ××”×™×¨×•×ª (O(1)) ×•×ª××™×›×” ×‘××™× ×¡×•×£ ××©×ª××©×™×.
//
// ğŸ­ ×ª×¤×§×™×“×™×:
//    1ï¸âƒ£ Owner (created_by): ×”×›×œ ×›×•×œ×œ ××—×™×§×ª ×”×¨×©×™××”.
//    2ï¸âƒ£ Admin (role='admin'): ×¢×¨×™×›×” ××œ××” ×•× ×™×”×•×œ ××©×ª××©×™× (×œ×œ× ××—×™×§×ª ×¨×©×™××”).
//    3ï¸âƒ£ Editor (role='editor'): ×¢×¨×™×›×ª ××•×¦×¨×™× ×‘×œ×‘×“.
//    4ï¸âƒ£ Viewer (role='viewer'): ×¦×¤×™×™×” ×‘×œ×‘×“.

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================
    // ğŸ› ï¸ Helper Functions
    // =========================================================

    // ×‘×“×™×§×” ×‘×¡×™×¡×™×ª - ×”×× ×”××©×ª××© ××—×•×‘×¨?
    function isAuthenticated() {
      return request.auth != null;
    }

    // ×‘×“×™×§×” ×× ×”××©×ª××© ×”×•× ×”×‘×¢×œ×™× ×©×œ ××¡××š ××™×©×™
    function isDocOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ×©×œ×™×¤×ª ×”-Household ID ×©×œ ×”××©×ª××© ×”× ×•×›×—×™
    function getUserHouseholdId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.household_id;
    }

    // ×‘×“×™×§×” ×× ×”××©×ª××© ×©×™×™×š ×œ-Household ×¡×¤×¦×™×¤×™
    function isHouseholdMember(householdId) {
      return isAuthenticated() &&
             getUserHouseholdId() == householdId;
    }

    // =========================================================
    // ğŸ” List Permissions Logic (Map Based ğŸ—ºï¸)
    // =========================================================

    // ×¤×•× ×§×¦×™×” ×©××—×–×™×¨×” ××ª ×”×ª×¤×§×™×“ ×©×œ ×”××©×ª××© ×‘×¨×©×™××”
    function getListRole(listData) {
      return listData.created_by == request.auth.uid
             ? 'owner'
             : (
                 listData.shared_users != null &&
                 request.auth.uid in listData.shared_users
                 ? listData.shared_users[request.auth.uid].role
                 : null
               );
    }

    // =========================================================
    // ğŸ‘¤ Users Collection & Subcollections
    // =========================================================

    // === User Profile ===
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isDocOwner(userId);

      // === ğŸ†• Private Lists (Subcollection) ===
      // Path: /users/{userId}/private_lists/{listId}
      match /private_lists/{listId} {

        // ğŸ‘ï¸ ×§×¨×™××”: ×¨×§ ×”×‘×¢×œ×™× ×©×œ ×”×¨×©×™××”
        allow read: if isDocOwner(userId);

        // â• ×™×¦×™×¨×”: ×¨×§ ×”×‘×¢×œ×™× ×™×›×•×œ ×œ×™×¦×•×¨ ×¨×©×™××•×ª ×¤×¨×˜×™×•×ª
        allow create: if isDocOwner(userId) &&
                      request.resource.data.created_by == request.auth.uid;

        // âœï¸ ×¢×“×›×•×Ÿ: ×¨×§ ×”×‘×¢×œ×™× ×™×›×•×œ ×œ×¢×¨×•×š ×¨×©×™××•×ª ×¤×¨×˜×™×•×ª
        allow update: if isDocOwner(userId);

        // ğŸ—‘ï¸ ××—×™×§×”: ×¨×§ ×”×‘×¢×œ×™× ×™×›×•×œ ×œ××—×•×§
        allow delete: if isDocOwner(userId);
      }

      // === ğŸ†• Notifications (Subcollection) ===
      // Path: /users/{userId}/notifications/{notificationId}
      match /notifications/{notificationId} {
        // ×§×¨×™××” ×•××—×™×§×”: ×¨×§ ×”×‘×¢×œ×™×
        allow read, delete: if isDocOwner(userId);

        // ×¢×“×›×•×Ÿ: ×¨×§ ×”×‘×¢×œ×™× (mark as read)
        allow update: if isDocOwner(userId);

        // ×™×¦×™×¨×”: ×›×œ ××©×ª××© ××—×•×‘×¨ ×™×›×•×œ ×œ×©×œ×•×— ×”×ª×¨××” ×œ××©×ª××© ××—×¨
        allow create: if isAuthenticated();
      }

      // === Pending Invites (Subcollection) ===
      // Path: /users/{userId}/pending_invites/{inviteId}
      match /pending_invites/{inviteId} {
        allow read, write: if isDocOwner(userId);
      }

      // === Saved Contacts (Subcollection) ===
      // Path: /users/{userId}/saved_contacts/{contactId}
      match /saved_contacts/{contactId} {
        allow read, write: if isDocOwner(userId);
      }
    }

    // =========================================================
    // ğŸ  Households Collection & Subcollections
    // =========================================================

    // === Household Info ===
    match /households/{householdId} {
      // ×§×¨×™××”: ×¨×§ ×—×‘×¨×™ ××©×§ ×”×‘×™×ª
      allow read: if isHouseholdMember(householdId);

      // ×™×¦×™×¨×”: ×›×œ ××©×ª××© ××—×•×‘×¨ ×™×›×•×œ ×œ×™×¦×•×¨ ××©×§ ×‘×™×ª
      allow create: if isAuthenticated();

      // ×¢×“×›×•×Ÿ: ×¨×§ ×—×‘×¨×™ ××©×§ ×”×‘×™×ª
      allow update: if isHouseholdMember(householdId);

      // ××—×™×§×”: ×œ× ×××¤×©×¨×™× (×œ×× ×•×¢ ××•×‘×“×Ÿ × ×ª×•× ×™×)
      allow delete: if false;

      // === ğŸ†• Shared Lists (Subcollection) ===
      // Path: /households/{householdId}/shared_lists/{listId}
      match /shared_lists/{listId} {

        // ğŸ‘ï¸ ×§×¨×™××”: ×—×‘×¨×™ ××©×§ ×”×‘×™×ª ××• ××™ ×©××©×•×ª×£ ×‘×¨×©×™××”
        allow read: if isAuthenticated() && (
          isHouseholdMember(householdId) ||
          (resource.data.shared_users != null && request.auth.uid in resource.data.shared_users)
        );

        // â• ×™×¦×™×¨×”: ×—×‘×¨ ××©×§ ×”×‘×™×ª (×—×•×‘×” ×œ×”×’×“×™×¨ created_by)
        allow create: if isHouseholdMember(householdId) &&
                      request.resource.data.created_by == request.auth.uid;

        // âœï¸ ×¢×“×›×•×Ÿ: ×œ×•×’×™×§×” ××¤×•×¦×œ×ª ×œ×¤×™ ×ª×¤×§×™×“×™×
        allow update: if isAuthenticated() && (

          // 1. Owner: ×™×›×•×œ ×œ×¢×©×•×ª ×”×›×œ
          getListRole(resource.data) == 'owner' ||

          // 2. Admin: ×™×›×•×œ ×œ×¢×¨×•×š ×”×›×œ ×—×•×¥ ××œ×©× ×•×ª ××ª ×”×‘×¢×œ×™×
          (getListRole(resource.data) == 'admin' &&
           request.resource.data.created_by == resource.data.created_by) ||

          // 3. Editor: ×™×›×•×œ ×œ×¢×¨×•×š ×¨×§ items ×•-updated_date ×•-pending_requests
          (getListRole(resource.data) == 'editor' &&
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['items', 'updated_date', 'pending_requests'])) ||

          // 4. Household member (×œ× Owner/Admin/Editor) - ×¦×¤×™×™×” ×‘×œ×‘×“
          false
        );

        // ğŸ—‘ï¸ ××—×™×§×”: ×¨×§ ×”×‘×¢×œ×™× ×”××§×•×¨×™
        allow delete: if isAuthenticated() &&
                      resource.data.created_by == request.auth.uid;
      }

      // === ğŸ†• Inventory (Subcollection) ===
      // Path: /households/{householdId}/inventory/{itemId}
      match /inventory/{itemId} {
        allow read, write: if isHouseholdMember(householdId);
      }

      // === ğŸ†• Receipts (Subcollection) ===
      // Path: /households/{householdId}/receipts/{receiptId}
      match /receipts/{receiptId} {
        allow read, write: if isHouseholdMember(householdId);
      }

      // === Members (Subcollection) ===
      // Path: /households/{householdId}/members/{memberId}
      match /members/{memberId} {
        allow read: if isHouseholdMember(householdId);
        allow write: if isHouseholdMember(householdId);
      }

      // === Invites (Subcollection) ===
      // Path: /households/{householdId}/invites/{inviteId}
      match /invites/{inviteId} {
        // ×§×¨×™××”: ×—×‘×¨×™ ××©×§ ×”×‘×™×ª ××• ××™ ×©×”×•×–××Ÿ
        allow read: if isAuthenticated() && (
          isHouseholdMember(householdId) ||
          resource.data.invited_user_id == request.auth.uid
        );
        // ×›×ª×™×‘×”: ×—×‘×¨×™ ××©×§ ×”×‘×™×ª
        allow write: if isHouseholdMember(householdId);
      }

      // === Join Requests (Subcollection) ===
      // Path: /households/{householdId}/join_requests/{requestId}
      match /join_requests/{requestId} {
        // ×§×¨×™××”: ×—×‘×¨×™ ××©×§ ×”×‘×™×ª ××• ××™ ×©×‘×™×§×© ×œ×”×¦×˜×¨×£
        allow read: if isAuthenticated() && (
          isHouseholdMember(householdId) ||
          resource.data.requester_id == request.auth.uid
        );
        // ×™×¦×™×¨×”: ×›×œ ××©×ª××© ××—×•×‘×¨ ×™×›×•×œ ×œ×‘×§×© ×œ×”×¦×˜×¨×£
        allow create: if isAuthenticated() &&
                      request.resource.data.requester_id == request.auth.uid;
        // ×¢×“×›×•×Ÿ/××—×™×§×”: ×—×‘×¨×™ ××©×§ ×”×‘×™×ª (×œ××©×¨/×œ×“×—×•×ª ×‘×§×©×•×ª)
        allow update, delete: if isHouseholdMember(householdId);
      }
    }

    // =========================================================
    // ğŸ“¦ Global Collections
    // =========================================================

    // === Products (Global Catalog) ===
    match /products/{productId} {
      allow read: if true;
      allow write: if false;
    }

    // =========================================================
    // ğŸš« Legacy Collections (Deprecated)
    // =========================================================
    // These rules are kept for backward compatibility during migration
    // Remove after migration is complete

    // === Legacy: shopping_lists (Deprecated) ===
    match /shopping_lists/{listId} {
      allow read: if isAuthenticated() && (
        resource.data.created_by == request.auth.uid ||
        (resource.data.household_id != null && isHouseholdMember(resource.data.household_id)) ||
        (resource.data.shared_users != null && request.auth.uid in resource.data.shared_users)
      );
      allow write: if false; // Read-only during migration
    }

    // === Legacy: receipts (Deprecated) ===
    match /receipts/{receiptId} {
      allow read: if isAuthenticated() &&
                  resource.data.household_id != null &&
                  isHouseholdMember(resource.data.household_id);
      allow write: if false; // Read-only during migration
    }

    // === Legacy: inventory (Deprecated) ===
    match /inventory/{itemId} {
      allow read: if isAuthenticated() &&
                  resource.data.household_id != null &&
                  isHouseholdMember(resource.data.household_id);
      allow write: if false; // Read-only during migration
    }

    // === Legacy: notifications (Deprecated) ===
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() &&
                  resource.data.user_id == request.auth.uid;
      allow write: if false; // Read-only during migration
    }

    // =========================================================
    // ğŸ”’ Default Deny
    // =========================================================

    // ×—×¡×™××ª ×›×œ ×”×©××¨
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
