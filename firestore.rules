rules_version = '2';

// ğŸ”’ MemoZap Firestore Security Rules
//
// âœ… ×¢×•×“×›×Ÿ: Phase 5 - Scalable RBAC with Maps
// 
// ğŸ“„ ××¢×¨×›×ª ×”×¨×©××•×ª ×œ×¨×©×™××•×ª ××©×•×ª×¤×•×ª (Map-Based):
//    ×‘××§×•× ××¢×¨×š, ××©×ª××©×™× ×‘××¤×”: shared_users = { "uid": { role: "..." } }
//    ×–×” ×××¤×©×¨ ×‘×“×™×§×•×ª ××”×™×¨×•×ª (O(1)) ×•×ª××™×›×” ×‘××™× ×¡×•×£ ××©×ª××©×™×.
//
// ğŸ­ ×ª×¤×§×™×“×™×:
//    1ï¸âƒ£ Owner (created_by): ×”×›×œ ×›×•×œ×œ ××—×™×§×ª ×”×¨×©×™××”.
//    2ï¸âƒ£ Admin (role='admin'): ×¢×¨×™×›×” ××œ××” ×•× ×™×”×•×œ ××©×ª××©×™× (×œ×œ× ××—×™×§×ª ×¨×©×™××”).
//    3ï¸âƒ£ Editor (role='editor'): ×¢×¨×™×›×ª ××•×¦×¨×™× ×‘×œ×‘×“.
//    4ï¸âƒ£ Viewer (role='viewer'): ×¦×¤×™×™×” ×‘×œ×‘×“.

service cloud.firestore {
  match /databases/{database}/documents {
    
    // =========================================================
    // ğŸ› ï¸ Helper Functions
    // =========================================================

    // ×‘×“×™×§×” ×‘×¡×™×¡×™×ª - ×”×× ×”××©×ª××© ××—×•×‘×¨?
    function isAuthenticated() {
      return request.auth != null;
    }

    // ×‘×“×™×§×” ×× ×”××©×ª××© ×”×•× ×”×‘×¢×œ×™× ×©×œ ××¡××š ××™×©×™
    function isDocOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ×©×œ×™×¤×ª ×”-Household ID (×“×•×¨×© ×§×¨×™××” × ×•×¡×¤×ª)
    function getUserHouseholdId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.household_id;
    }

    // ×‘×“×™×§×” ×× ×”××©×ª××© ×©×™×™×š ×œ-Household ×¡×¤×¦×™×¤×™
    function isHouseholdMember(householdId) {
      return isAuthenticated() && 
             getUserHouseholdId() == householdId;
    }

    // ×‘×“×™×§×” ×©×”××¡××š ×”×—×“×© ××›×™×œ household_id ×ª×§×™×Ÿ
    function hasValidHouseholdId() {
       return request.resource.data.keys().hasAll(['household_id']) &&
              request.resource.data.household_id == getUserHouseholdId();
    }

    // =========================================================
    // ğŸ” List Permissions Logic (Map Based ğŸ—ºï¸)
    // =========================================================

    // ×¤×•× ×§×¦×™×” ×©××—×–×™×¨×” ××ª ×”×ª×¤×§×™×“ ×©×œ ×”××©×ª××© ×‘×¨×©×™××”
    // ××§×‘×œ×ª ××ª ×”× ×ª×•× ×™× ×©×œ ×”××¡××š (listData)
    function getListRole(listData) {
      return listData.created_by == request.auth.uid 
             ? 'owner' // ×× ×× ×™ ×™×¦×¨×ª×™ -> ×× ×™ ×”×‘×¢×œ×™×
             : (
                 listData.shared_users != null && 
                 request.auth.uid in listData.shared_users // ğŸ”¥ ×‘×“×™×§×” ××”×™×¨×” ×‘××¤×”!
                 ? listData.shared_users[request.auth.uid].role 
                 : null
               );
    }

    // =========================================================
    // ğŸ“‚ Collections Rules
    // =========================================================

    // === Users ===
    match /users/{userId} {
      allow read: if isAuthenticated(); 
      allow write: if isDocOwner(userId);
    }

    // === Shopping Lists (×”×œ×‘ ×©×œ ×”××¢×¨×›×ª) ===
    match /shopping_lists/{listId} {
      
      // ğŸ‘ï¸ ×§×¨×™××”: ×‘×¢×œ×™×, ×—×‘×¨×™ ××©×¤×—×”, ××• ××™ ×©××©×•×ª×£ ×‘×¨×©×™××”
      allow read: if isAuthenticated() && (
        resource.data.created_by == request.auth.uid || 
        isHouseholdMember(resource.data.household_id) ||
        (resource.data.shared_users != null && request.auth.uid in resource.data.shared_users)
      );

      // â• ×™×¦×™×¨×”: ×›×œ ××©×ª××© ××—×•×‘×¨ (×—×•×‘×” ×œ×”×’×“×™×¨ household_id ×•-created_by)
      allow create: if isAuthenticated() && 
                    hasValidHouseholdId() &&
                    request.resource.data.created_by == request.auth.uid;

      // âœï¸ ×¢×“×›×•×Ÿ: ×œ×•×’×™×§×” ××¤×•×¦×œ×ª ×œ×¤×™ ×ª×¤×§×™×“×™×
      allow update: if isAuthenticated() && (
        
        // 1. Owner: ×™×›×•×œ ×œ×¢×©×•×ª ×”×›×œ (×›×•×œ×œ ×©×™× ×•×™ ×©×, ××—×™×§×ª ××©×ª××©×™× ×•×›×•')
        getListRole(resource.data) == 'owner' ||

        // 2. Admin: ×™×›×•×œ ×œ×¢×¨×•×š ×”×›×œ ×—×•×¥ ××œ×©× ×•×ª ××ª ×”×‘×¢×œ×™× ×¢×¦××•
        (getListRole(resource.data) == 'admin' && 
         request.resource.data.created_by == resource.data.created_by) ||

        // 3. Editor: ×™×›×•×œ ×œ×¢×¨×•×š ×¨×§ ××ª ××¢×¨×š ×”-items (××•×¦×¨×™×) ×•-updated_date
        // ××¡×•×¨ ×œ×• ×œ×©× ×•×ª ×©× ×¨×©×™××”, ××• ×œ×’×¢×ª ×‘××©×ª××©×™× ××—×¨×™×!
        (getListRole(resource.data) == 'editor' && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['items', 'updated_date', 'pending_requests'])) ||
         
        // 4. Viewer: ×œ× ×™×›×•×œ ×œ×¢×¨×•×š ×›×œ×•× (××™×Ÿ allow update ×œ-viewer)
        
        // 5. ××§×¨×™× ××™×•×—×“×™×: ×”×¦×˜×¨×¤×•×ª/×¢×–×™×‘×” ×¢×¦××™×ª (××•×¤×¦×™×•× ×œ×™, ×›×¨×’×¢ ×× ×•×”×œ ×¢"×™ Owner)
        false
      );

      // ğŸ—‘ï¸ ××—×™×§×”: ×¨×§ ×”×‘×¢×œ×™× ×”××§×•×¨×™ (Owner) ×™×›×•×œ ×œ××—×•×§ ××ª ×”×¨×©×™××” ×œ× ×¦×—!
      allow delete: if isAuthenticated() && 
                    resource.data.created_by == request.auth.uid;
    }

    // === Products (Global Catalog) ===
    match /products/{productId} {
      allow read: if true; 
      allow write: if false; 
    }

    // === Receipts & Inventory ===
    match /receipts/{receiptId} {
      allow read, write: if isHouseholdMember(resource.data.household_id);
    }
    
    match /inventory/{itemId} {
      allow read, write: if isHouseholdMember(resource.data.household_id);
    }

    // === Pending Invites & Requests ===
    match /pending_invites/{inviteId} {
      allow read, write: if isAuthenticated() && 
        (resource.data.requester_id == request.auth.uid || resource.data.request_data.invited_user_id == request.auth.uid);
    }

    // ×—×¡×™××ª ×›×œ ×”×©××¨
    match /{document=**} {
      allow read, write: if false;
    }
  }
}